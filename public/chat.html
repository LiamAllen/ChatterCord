<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <meta http-equiv="X-UA-Compatible" content="ie=edge" />
   <link rel="stylesheet" type="text/css" href="/css/index.css">
   <title>ChatterCord v0.0.1</title>
 </head>
 <body>
   <div class="banner">
     <a href="/login"><h2 class="navitem">Login</h2></a>
     <a href="/"><h1 class="navitem">ChatterCord v0.0.1</h1></a>
     <a href="/chat"><h2 class="navitem_c">Join Chatroom!</h2></a>
     <a href="/profile"><h2 class="navitem">Profile</h2></a>
     <a href="/contact"><h2 class="navitem">Contact</h2></a>
   </div>
   <div class="msgBox">
     <h2>Messages</h2>
     <ul class="msgList"></ul>
   </div>
   <form action="" class="msgForm">
     <input type="text" />
     <button class="msgSubmit">Send</button>
   </form>
   <script src="/socket.io/socket.io.js"></script>
   <script>

    // select relevant elements
    const form = document.querySelector("form");
    const input = document.querySelector("input");
    messageList = document.querySelector("ul");
   
    // establish socket.io connection
    const socket = io();
    let user;

    fetchData();

    async function fetchData() {
        try{
            const response = await fetch('/api/userData'); //Make request to server endpoint.
            if(!response.ok){
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
           const jsonData = await response.json();
           setUsername(jsonData);

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    //set username
    function setUsername(data) {
      userData = JSON.parse(data);
      user = userData.login;
    }

    //handle room identification and socket connection to different rooms
    function joinRoom() {
        socket.emit("join", roomID);
    }
    // handle sending message to server & input reset
    function sendMessage(e) {
      // prevent form submission refreshing page
      e.preventDefault();
      // send input value to server as type 'message'
      socket.emit("message", user + ": " + input.value);
      // reset input value
      input.value = "";
    }
   
    // add listener to form submission
    form.addEventListener("submit", sendMessage);
   
    // add message to our page
    function addMessageToHTML(message) {
      // create a new li element
      const li = document.createElement("li");
      //define class of li element
      li.className = "msg";
      // add message to the elements text
      li.innerText = message;
      // add to list of messages
      messageList.append(li);
    }
     // watch for socket to emit a 'message'
    socket.on("message", addMessageToHTML);
   
    // display message when a user connects
    function alertUserConnected() {
      addMessageToHTML("User connected");
    }
     // watch for socket to emit a 'user connected' event
    socket.on("user connected", joinRoom);
   
   </script>
 </body>
</html>